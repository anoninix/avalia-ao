<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bom Mercado - Avalia√ß√£o</title>
<style>
  /* Reset b√°sico */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #000000, #222222);
    color: #fff;
    margin: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 20px;
  }
  #container {
    background: #111;
    border-radius: 12px;
    max-width: 400px;
    width: 100%;
    padding: 20px 30px;
    box-shadow: 0 0 15px #facc15aa;
  }
  h1 {
    color: #facc15;
    text-align: center;
    margin-bottom: 10px;
    font-weight: 900;
    text-shadow: 0 0 8px #facc15;
  }
  p.subtitle {
    text-align: center;
    color: #f0db4fcc;
    margin-bottom: 20px;
    font-weight: 600;
  }
  fieldset {
    border: none;
    margin: 0;
    padding: 0;
    display: none;
  }
  fieldset.active {
    display: block;
  }
  legend {
    font-weight: 700;
    margin-bottom: 10px;
    color: #facc15;
    text-shadow: 0 0 6px #facc15bb;
  }
  input[type="number"], textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    background: #222;
    color: #facc15;
    box-shadow: inset 0 0 8px #facc15aa;
    margin-bottom: 10px;
  }
  textarea {
    resize: vertical;
    min-height: 70px;
  }
  label {
    display: block;
    margin-bottom: 4px;
    font-weight: 600;
  }
  button {
    background: #facc15;
    border: none;
    padding: 12px 25px;
    font-weight: 700;
    border-radius: 30px;
    cursor: pointer;
    color: #000;
    font-size: 1rem;
    margin: 5px;
    transition: background 0.3s ease;
    box-shadow: 0 0 8px #facc15bb;
  }
  button:hover {
    background: #d4af37;
  }
  #nav-buttons {
    text-align: center;
    margin-top: 15px;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  /* Barra de progresso */
  #progress-bar {
    width: 100%;
    height: 12px;
    background: #333;
    border-radius: 30px;
    overflow: hidden;
    margin-bottom: 15px;
  }
  #progress {
    height: 12px;
    background: #facc15;
    width: 0%;
    transition: width 0.3s ease;
  }
  /* Login admin discreto */
  #login-btn {
    position: fixed;
    top: 12px;
    left: 12px;
    font-size: 0.9rem;
    color: #facc15aa;
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 600;
    text-shadow: 0 0 3px #facc15aa;
    user-select: none;
    transition: color 0.3s ease;
  }
  #login-btn:hover {
    color: #facc15;
  }
  /* Modal login */
  #modal-login {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  #modal-login.active {
    display: flex;
  }
  #modal-login .modal-content {
    background: #222;
    padding: 25px 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 360px;
    box-shadow: 0 0 12px #facc15aa;
    color: #facc15;
    text-align: center;
  }
  #modal-login input[type="password"] {
    margin-top: 15px;
    padding: 10px 12px;
    width: 100%;
    font-size: 1.1rem;
    border-radius: 8px;
    border: none;
    background: #111;
    color: #facc15;
    box-shadow: inset 0 0 8px #facc15aa;
  }
  #modal-login button {
    margin-top: 15px;
    width: 100%;
  }
  #error-msg {
    margin-top: 10px;
    color: #ff5555;
    font-weight: 700;
    display: none;
  }
  /* Painel admin */
  #admin-panel {
    max-width: 700px;
    margin: 30px auto 0;
    background: #111;
    border-radius: 12px;
    padding: 20px;
    color: #facc15;
    box-shadow: 0 0 15px #facc15bb;
    display: none;
  }
  #admin-panel h2 {
    text-align: center;
    margin-bottom: 15px;
    font-weight: 900;
    font-size: 1.8rem;
  }
  #admin-table {
    width: 100%;
    border-collapse: collapse;
  }
  #admin-table th, #admin-table td {
    border: 1px solid #facc15bb;
    padding: 8px 10px;
    text-align: left;
  }
  #admin-table th {
    background: #222;
  }
</style>
</head>
<body>

<button id="login-btn" title="Login administrativo">Bom Mercado</button>

<div id="modal-login" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <h2 id="modalTitle">Login Administrativo</h2>
    <input type="password" id="admin-password" placeholder="Senha..." aria-label="Senha administrativa" />
    <button id="admin-login-btn">Entrar</button>
    <div id="error-msg">Senha incorreta!</div>
  </div>
</div>

<div id="container" role="main" aria-live="polite">

  <h1>Bom Mercado</h1>
  <p class="subtitle">Sua opini√£o √© muito importante para melhorarmos cada vez mais.</p>

  <div id="progress-bar" aria-label="Progresso do formul√°rio">
    <div id="progress"></div>
  </div>

  <form id="form-avaliacao" novalidate>

    <!-- Etapa 1 -->
    <fieldset class="active" data-step="1">
      <legend>1. Qual nota geral voc√™ d√° para o Bom Mercado? (1 a 5)</legend>
      <input type="number" id="nota-geral" name="notaGeral" min="1" max="5" required aria-required="true" />
      <div id="explicacao-geral" style="display:none;">
        <label for="motivo-geral">Por favor, explique o motivo da nota baixa:</label>
        <textarea id="motivo-geral" name="motivoGeral" placeholder="Explique aqui..."></textarea>
      </div>
    </fieldset>

    <!-- Etapa 2 -->
    <fieldset data-step="2">
      <legend>2. Avalie nossos funcion√°rios (1 a 5)</legend>

      <label for="nota-joao">Jo√£o (Caixa):</label>
      <input type="number" id="nota-joao" name="notaJoao" min="1" max="5" required aria-required="true" />
      <div class="explicacao-func" id="explicacao-joao" style="display:none;">
        <label for="motivo-joao">Por que nota baixa para o Jo√£o?</label>
        <textarea id="motivo-joao" name="motivoJoao" placeholder="Explique aqui..."></textarea>
      </div>

      <label for="nota-maria">Maria (Padaria):</label>
      <input type="number" id="nota-maria" name="notaMaria" min="1" max="5" required aria-required="true" />
      <div class="explicacao-func" id="explicacao-maria" style="display:none;">
        <label for="motivo-maria">Por que nota baixa para a Maria?</label>
        <textarea id="motivo-maria" name="motivoMaria" placeholder="Explique aqui..."></textarea>
      </div>

      <label for="nota-thais">Thais (Caixa):</label>
      <input type="number" id="nota-thais" name="notaThais" min="1" max="5" required aria-required="true" />
      <div class="explicacao-func" id="explicacao-thais" style="display:none;">
        <label for="motivo-thais">Por que nota baixa para a Thais?</label>
        <textarea id="motivo-thais" name="motivoThais" placeholder="Explique aqui..."></textarea>
      </div>

      <label for="nota-eduarda">Maria Eduarda (Padaria):</label>
      <input type="number" id="nota-eduarda" name="notaEduarda" min="1" max="5" required aria-required="true" />
      <div class="explicacao-func" id="explicacao-eduarda" style="display:none;">
        <label for="motivo-eduarda">Por que nota baixa para a Maria Eduarda?</label>
        <textarea id="motivo-eduarda" name="motivoEduarda" placeholder="Explique aqui..."></textarea>
      </div>

      <label for="nota-renata">Renata (Dona):</label>
      <input type="number" id="nota-renata" name="notaRenata" min="1" max="5" required aria-required="true" />
      <div class="explicacao-func" id="explicacao-renata" style="display:none;">
        <label for="motivo-renata">Por que nota baixa para a Renata?</label>
        <textarea id="motivo-renata" name="motivoRenata" placeholder="Explique aqui..."></textarea>
      </div>

      <label for="nota-toni">Toni (Dono):</label>
      <input type="number" id="nota-toni" name="notaToni" min="1" max="5" required aria-required="true" />
      <div class="explicacao-func" id="explicacao-toni" style="display:none;">
        <label for="motivo-toni">Por que nota baixa para o Toni?</label>
        <textarea id="motivo-toni" name="motivoToni" placeholder="Explique aqui..."></textarea>
      </div>
    </fieldset>

    <!-- Etapa 3 -->
    <fieldset data-step="3">
      <legend>3. Coment√°rios gerais sobre o mercado (atendimento, limpeza, organiza√ß√£o etc.)</legend>
      <textarea id="comentarios-gerais" name="comentariosGerais" placeholder="Escreva aqui..." required aria-required="true"></textarea>
    </fieldset>

    <!-- Etapa 4 -->
    <fieldset data-step="4">
      <legend>4. Produtos que gostaria que tivessem no Bom Mercado</legend>
      <textarea id="produtos-desejados" name="produtosDesejados" placeholder="Liste aqui..." required aria-required="true"></textarea>
    </fieldset>

    <!-- Etapa 5 -->
    <fieldset data-step="5">
      <legend>5. O que podemos melhorar para tornar o Bom Mercado ainda melhor?</legend>
      <textarea id="melhorias" name="melhorias" placeholder="Conte pra gente..." required aria-required="true"></textarea>
    </fieldset>

    <!-- Etapa final -->
    <fieldset data-step="6" style="text-align:center;">
      <h2>Obrigado pela sua avalia√ß√£o! üôè</h2>
      <p>Sua opini√£o nos ajuda a crescer e melhorar o Bom Mercado.</p>
      <button type="button" id="btn-nova-avaliacao" style="margin-top:20px;">Fazer outra avalia√ß√£o</button>
    </fieldset>

    <div id="nav-buttons" aria-label="Navega√ß√£o do formul√°rio">
      <button type="button" id="btn-voltar" disabled>Voltar</button>
      <button type="button" id="btn-proximo">Pr√≥ximo</button>
      <button type="submit" id="btn-enviar" style="display:none;">Enviar</button>
    </div>
  </form>
</div>

<!-- Painel admin -->
<div id="admin-panel" aria-live="polite">
  <h2>Painel Administrativo</h2>
  <table id="admin-table" aria-label="Tabela de avalia√ß√µes">
    <thead>
      <tr>
        <th>Data</th>
        <th>Nota Geral</th>
        <th>Coment√°rio</th>
      </tr>
    </thead>
    <tbody id="admin-tbody"></tbody>
  </table>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>

<script>
  // Config Firebase
  const firebaseConfig = {
    databaseURL: "https://site-46fb6-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Controle das etapas do formul√°rio
  const steps = Array.from(document.querySelectorAll('fieldset'));
  const btnVoltar = document.getElementById('btn-voltar');
  const btnProximo = document.getElementById('btn-proximo');
  const btnEnviar = document.getElementById('btn-enviar');
  const btnNovaAvaliacao = document.getElementById('btn-nova-avaliacao');
  const progress = document.getElementById('progress');

  let currentStep = 0;

  function showStep(index) {
    steps.forEach((step, i) => {
      step.classList.toggle('active', i === index);
    });
    btnVoltar.disabled = index === 0;
    btnProximo.style.display = (index === steps.length - 2) ? 'none' : 'inline-block';
    btnEnviar.style.display = (index === steps.length - 2) ? 'inline-block' : 'none';
    progress.style.width = ((index) / (steps.length - 1)) * 100 + '%';
  }

  function validateStep(index) {
    const step = steps[index];
    const inputs = Array.from(step.querySelectorAll('input, textarea'));
    for (const input of inputs) {
      if (input.hasAttribute('required') && !input.value.trim()) {
        alert('Por favor, preencha o campo: ' + (input.previousElementSibling ? input.previousElementSibling.innerText : input.name));
        input.focus();
        return false;
      }
      if (input.type === "number") {
        const val = Number(input.value);
        if (val < Number(input.min) || val > Number(input.max)) {
          alert(`Valor inv√°lido para o campo: ${input.previousElementSibling ? input.previousElementSibling.innerText : input.name}`);
          input.focus();
          return false;
        }
      }
    }
    // Valida√ß√£o extra para notas baixas com explica√ß√£o
    if (index === 0) {
      const notaGeral = Number(document.getElementById('nota-geral').value);
      const motivoGeral = document.getElementById('motivo-geral');
      if (notaGeral <= 2 && !motivoGeral.value.trim()) {
        alert('Por favor, explique o motivo da nota baixa na avalia√ß√£o geral.');
        motivoGeral.focus();
        return false;
      }
    }
    if (index === 1) {
      // Validar explica√ß√£o para notas baixas dos funcion√°rios
      const funcionarios = ['joao', 'maria', 'thais', 'eduarda', 'renata', 'toni'];
      for (const f of funcionarios) {
        const nota = Number(document.getElementById('nota-' + f).value);
        const motivo = document.getElementById('motivo-' + f);
        if (nota <= 2 && !motivo.value.trim()) {
          alert(`Por favor, explique o motivo da nota baixa para ${f.charAt(0).toUpperCase() + f.slice(1)}.`);
          motivo.focus();
          return false;
        }
      }
    }
    return true;
  }

  btnProximo.addEventListener('click', () => {
    if (!validateStep(currentStep)) return;
    currentStep++;
    showStep(currentStep);
  });

  btnVoltar.addEventListener('click', () => {
    if (currentStep === 0) return;
    currentStep--;
    showStep(currentStep);
  });

  btnNovaAvaliacao.addEventListener('click', () => {
    document.getElementById('form-avaliacao').reset();
    currentStep = 0;
    showStep(currentStep);
  });

  // Mostrar/ocultar explica√ß√£o para notas baixas (geral)
  document.getElementById('nota-geral').addEventListener('input', e => {
    const val = Number(e.target.value);
    const container = document.getElementById('explicacao-geral');
    container.style.display = (val > 0 && val <= 2) ? 'block' : 'none';
    if (val > 2) document.getElementById('motivo-geral').value = '';
  });

  // Mostrar/ocultar explica√ß√µes para notas baixas (funcion√°rios)
  const funcionarios = ['joao', 'maria', 'thais', 'eduarda', 'renata', 'toni'];
  funcionarios.forEach(f => {
    const input = document.getElementById('nota-' + f);
    const contExp = document.getElementById('explicacao-' + f);
    input.addEventListener('input', e => {
      const val = Number(e.target.value);
      if (val > 0 && val <= 2) {
        contExp.style.display = 'block';
      } else {
        contExp.style.display = 'none';
        document.getElementById('motivo-' + f).value = '';
      }
    });
  });

  // Enviar dados para Firebase
  document.getElementById('form-avaliacao').addEventListener('submit', e => {
    e.preventDefault();

    if (!validateStep(currentStep)) return;

    // Montar objeto para salvar
    const dados = {
      timestamp: new Date().toISOString(),
      notaGeral: Number(document.getElementById('nota-geral').value),
      motivoGeral: document.getElementById('motivo-geral').value.trim(),
      funcionarios: {},
      comentariosGerais: document.getElementById('comentarios-gerais').value.trim(),
      produtosDesejados: document.getElementById('produtos-desejados').value.trim(),
      melhorias: document.getElementById('melhorias').value.trim()
    };

    funcionarios.forEach(f => {
      dados.funcionarios[f] = {
        nota: Number(document.getElementById('nota-' + f).value),
        motivo: document.getElementById('motivo-' + f).value.trim()
      };
    });

    // Salvar no Firebase
    db.ref('avaliacoes').push(dados)
      .then(() => {
        alert('Avalia√ß√£o enviada com sucesso! Muito obrigado!');
        currentStep++;
        showStep(currentStep);
        document.getElementById('form-avaliacao').reset();
      })
      .catch(err => {
        alert('Erro ao enviar avalia√ß√£o. Tente novamente.');
        console.error(err);
      });
  });

  // Login admin modal e painel
  const loginBtn = document.getElementById('login-btn');
  const modalLogin = document.getElementById('modal-login');
  const adminLoginBtn = document.getElementById('admin-login-btn');
  const adminPasswordInput = document.getElementById('admin-password');
  const errorMsg = document.getElementById('error-msg');
  const adminPanel = document.getElementById('admin-panel');
  const adminTbody = document.getElementById('admin-tbody');

  loginBtn.addEventListener('click', () => {
    modalLogin.classList.add('active');
    errorMsg.style.display = 'none';
    adminPasswordInput.value = '';
    adminPasswordInput.focus();
  });

  adminLoginBtn.addEventListener('click', () => {
    const senha = adminPasswordInput.value.trim();
    const senhaCorreta = 'bommercado123'; // Troque a senha aqui

    if (senha === senhaCorreta) {
      modalLogin.classList.remove('active');
      adminPanel.style.display = 'block';
      carregarAvaliacoes();
    } else {
      errorMsg.style.display = 'block';
      adminPasswordInput.focus();
    }
  });

  modalLogin.addEventListener('click', e => {
    if (e.target === modalLogin) modalLogin.classList.remove('active');
  });

  function carregarAvaliacoes() {
    adminTbody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
    db.ref('avaliacoes').once('value')
      .then(snapshot => {
        const data = snapshot.val();
        if (!data) {
          adminTbody.innerHTML = '<tr><td colspan="3">Nenhuma avalia√ß√£o registrada.</td></tr>';
          return;
        }
        let rows = '';
        Object.values(data).forEach(av => {
          rows += `
            <tr>
              <td>${new Date(av.timestamp).toLocaleString()}</td>
              <td>${av.notaGeral}</td>
              <td>${av.comentariosGerais ? av.comentariosGerais.substring(0, 50) + '...' : '-'}</td>
            </tr>
          `;
        });
        adminTbody.innerHTML = rows;
      })
      .catch(() => {
        adminTbody.innerHTML = '<tr><td colspan="3">Erro ao carregar avalia√ß√µes.</td></tr>';
      });
  }

  // Inicializa o formul√°rio na primeira etapa
  showStep(currentStep);
</script>

</body>
</html>
